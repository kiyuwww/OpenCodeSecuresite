<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Three-Step Secure Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Montserrat:wght@300;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      transition: background-color 0.8s ease;
      overflow: hidden;
      background-color: #1e293b;
      color: white;
    }
    .title-font { font-family: 'Orbitron', sans-serif; }
    .input-field {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px);
    }
    .btn {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .btn:after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    .btn:focus:not(:active)::after { animation: ripple 1s ease-out; }
    @keyframes ripple { 0% { transform: scale(0,0); opacity:0.5; } 100% { transform: scale(20,20); opacity:0; } }
    .final-page {
      background:#000; color:#fff; padding:40px; border-radius:12px; text-align:center;
    }
    .welcome-text {
      font-family:'Orbitron', sans-serif; font-size:3rem; font-weight:700; animation:fadeIn 2s ease-out forwards;
      opacity:0;
    }
    .subtitle { margin-top:8px; color:#cfd6dd; font-size:1.2rem; opacity:0; animation:fadeIn 2s ease-out forwards; animation-delay:1s; animation-fill-mode:forwards; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div id="stage" class="flex items-center justify-center w-full">
    <div class="max-w-md w-full p-8 rounded-lg shadow-2xl bg-gray-800 bg-opacity-80 backdrop-blur-sm transition-all duration-500">
      <!-- Step 1 -->
      <div id="form1">
        <h1 class="text-2xl font-bold mb-4 title-font">Step 1 — Авторизация</h1>
        <p class="text-gray-300 mb-4">Введите логин и пароль</p>
        <input id="login1" type="text" placeholder="Логин" class="w-full px-4 py-3 rounded-lg input-field mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        <input id="pass1" type="password" placeholder="Пароль" class="w-full px-4 py-3 rounded-lg input-field mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        <button id="btn1" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium btn focus:outline-none focus:ring-2 focus:ring-blue-500">Отправить</button>
        <div id="msg1" class="text-sm text-gray-300 mt-2"></div>
      </div>
      <!-- Step 2 -->
      <div id="form2" class="hidden">
        <h1 class="text-2xl font-bold mb-4 title-font">Step 2 — Второй ввод</h1>
        <input id="login2" type="text" placeholder="Логин" class="w-full px-4 py-3 rounded-lg input-field mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        <input id="pass2" type="password" placeholder="Пароль" class="w-full px-4 py-3 rounded-lg input-field mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        <button id="btn2" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium btn focus:outline-none focus:ring-2 focus:ring-blue-500">Отправить</button>
        <div id="msg2" class="text-sm text-gray-300 mt-2"></div>
      </div>
      <!-- Step 3 -->
      <div id="form3" class="hidden">
        <h1 class="text-2xl font-bold mb-4 title-font">Step 3 — Последний ввод</h1>
        <input id="login3" type="text" placeholder="Логин" class="w-full px-4 py-3 rounded-lg input-field mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        <input id="pass3" type="password" placeholder="Пароль" class="w-full px-4 py-3 rounded-lg input-field mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        <button id="btn3" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium btn focus:outline-none focus:ring-2 focus:ring-blue-500">Отправить</button>
        <div id="msg3" class="text-sm text-gray-300 mt-2"></div>
      </div>
    </div>
  </div>

  <script>
    const MASTER_KEY = 'embed_master_key_!ChangeMe';
    const EXPECTED = {
      step1: 'VlkNn2VImD5NtyCMTsMVuWOIGpnFT1IqgyjuQUBw8d0=',
      step2: 'Y3TSylbXyAujuf9PDHMlEnfe25PuYO9HfTfxbfZtDaA=',
      step3: 'AMy+4hyov8B57aOwbaS2ctwy0HcX8qNi8DoU5HXMK1I='
    };

    const LOCKOUT_CONFIG = { initial: { attempts: 3, duration: 5*60*1000 }, extended: { attempts: 6, duration: 30*60*1000 } };
    const STORAGE_KEYS = { FAILED_ATTEMPTS: 'failed_login_attempts', LOCKED_UNTIL: 'login_locked_until' };

    async function importKeyRaw(keyStr){
      return await crypto.subtle.importKey('raw', new TextEncoder().encode(keyStr), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
    }
    async function hmacBase64(keyCrypto, message){
      const sig = await crypto.subtle.sign('HMAC', keyCrypto, new TextEncoder().encode(message));
      return btoa(String.fromCharCode(...new Uint8Array(sig)));
    }

    function secureCompare(a,b){
      if(a.length !== b.length) return false;
      let res=0;
      for(let i=0;i<a.length;i++) res |= a.charCodeAt(i)^b.charCodeAt(i);
      return res===0;
    }

    function setBackgroundColor(color){ document.body.style.backgroundColor = color; }

    function getFailedAttempts(){ return parseInt(localStorage.getItem(STORAGE_KEYS.FAILED_ATTEMPTS)) || 0; }
    function incrementFailedAttempts(){ const attempts = getFailedAttempts()+1; localStorage.setItem(STORAGE_KEYS.FAILED_ATTEMPTS, attempts); return attempts; }
    function resetFailedAttempts(){
      localStorage.removeItem(STORAGE_KEYS.FAILED_ATTEMPTS);
      localStorage.removeItem(STORAGE_KEYS.LOCKED_UNTIL);
    }
    function setLockout(duration){ localStorage.setItem(STORAGE_KEYS.LOCKED_UNTIL, Date.now()+duration); }
    function isLockedOut(){ const lockedUntil = parseInt(localStorage.getItem(STORAGE_KEYS.LOCKED_UNTIL)); if(!lockedUntil) return false; if(Date.now()>lockedUntil){ resetFailedAttempts(); return false;} return true;}
    function getTimeUntilUnlock(){ const lockedUntil = parseInt(localStorage.getItem(STORAGE_KEYS.LOCKED_UNTIL)); return Math.max(0, Math.ceil((lockedUntil - Date.now())/1000)); }

    function checkAndHandleLockout(step){
      if(!isLockedOut()) return false;
      const secondsLeft = getTimeUntilUnlock();
      const minutes = Math.floor(secondsLeft/60);
      const seconds = secondsLeft%60;
      const msgEl = document.getElementById(`msg${step}`);
      if(msgEl) msgEl.textContent = `Слишком много неудачных попыток. Попробуйте через ${minutes}:${seconds.toString().padStart(2,'0')}`;
      ['btn1','btn2','btn3'].forEach(id=>{ const btn = document.getElementById(id); if(btn) btn.disabled = true; });
      return true;
    }

    (async()=>{
      const key = await importKeyRaw(MASTER_KEY);

      async function verifyStep(login, pass, expected){
        const sig = await hmacBase64(key, login+':'+pass);
        return secureCompare(sig, expected);
      }

      function handleStep(step, loginId, passId, expectedSig, nextFormId){
        const btn = document.getElementById(`btn${step}`);
        const msgEl = document.getElementById(`msg${step}`);
        if(!btn) return;
        btn.addEventListener('click', async()=>{
          if(checkAndHandleLockout(step)) return;
          const l = document.getElementById(loginId).value.trim();
          const p = document.getElementById(passId).value;
          const ok = await verifyStep(l,p,expectedSig);
          if(ok){
            resetFailedAttempts();
            setBackgroundColor('#0b612a');
            if(nextFormId){
              document.getElementById(`form${step}`).classList.add('hidden');
              document.getElementById(nextFormId).classList.remove('hidden');
            } else {
              document.getElementById('stage').innerHTML = `
                <div class="final-page">
                  <div class="welcome-text">Welcome!</div>
                  <div class="subtitle">Добро пожаловать — доступ разрешён.</div>
                </div>`;
              setBackgroundColor('#000');
            }
            if(msgEl) msgEl.textContent = `Step ${step}: успешно.`;
          } else {
            const attempts = incrementFailedAttempts();
            let lockoutTime = null;
            if(attempts>=LOCKOUT_CONFIG.extended.attempts) lockoutTime=LOCKOUT_CONFIG.extended.duration;
            else if(attempts>=LOCKOUT_CONFIG.initial.attempts) lockoutTime=LOCKOUT_CONFIG.initial.duration;
            if(lockoutTime) setLockout(lockoutTime);
            checkAndHandleLockout(step);
            if(!isLockedOut() && msgEl){
              const remaining = Math.max(0, LOCKOUT_CONFIG.initial.attempts-attempts);
              setBackgroundColor('#6b0b0b');
              msgEl.textContent = `Step ${step}: неверный логин или пароль. Осталось попыток: ${remaining}`;
            }
          }
        });
      }

      handleStep('1','login1','pass1',EXPECTED.step1,'form2');
      handleStep('2','login2','pass2',EXPECTED.step2,'form3');
      handleStep('3','login3','pass3',EXPECTED.step3,null);

      window.addEventListener('load',()=>{ checkAndHandleLockout('1'); });
    })();
  </script>
</body>
</html>
