<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- Остальная часть head без изменений -->
  <style>/* Ваши оригинальные стили остаются здесь */</style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <!-- Ваша оригинальная разметка форм остается здесь без изменений -->

  <script>
    // Demo HMAC keys (можно оставить, для реальной защиты используйте сервер)
    const MASTER_KEY = 'embed_master_key_!ChangeMe';
    const EXPECTED = {
      step1: 'VlkNn2VImD5NtyCMTsMVuWOIGpnFT1IqgyjuQUBw8d0=',
      step2: 'Y3TSylbXyAujuf9PDHMlEnfe25PuYO9HfTfxbfZtDaA=',
      step3: 'AMy+4hyov8B57aOwbaS2ctwy0HcX8qNi8DoU5HXMK1I='
    };

    // Конфигурация блокировки
    const LOCKOUT_CONFIG = {
      initial: { attempts: 3, duration: 5 * 60 * 1000 }, // 5 минут
      extended: { attempts: 6, duration: 30 * 60 * 1000 } // 30 минут
    };

    // Ключи для localStorage
    const STORAGE_KEYS = {
      FAILED_ATTEMPTS: 'failed_login_attempts',
      LOCKED_UNTIL: 'login_locked_until'
    };

    async function importKeyRaw(keyStr){
      const enc = new TextEncoder();
      return await crypto.subtle.importKey('raw', enc.encode(keyStr), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
    }

    async function hmacBase64(keyCrypto, message){
      const enc = new TextEncoder();
      const sig = await crypto.subtle.sign('HMAC', keyCrypto, enc.encode(message));
      return btoa(String.fromCharCode(...new Uint8Array(sig)));
    }

    function setBackgroundColor(color){
      document.body.style.backgroundColor = color;
    }

    // Функции для работы с блокировкой
    function getFailedAttempts() {
      return parseInt(localStorage.getItem(STORAGE_KEYS.FAILED_ATTEMPTS)) || 0;
    }

    function incrementFailedAttempts() {
      const attempts = getFailedAttempts() + 1;
      localStorage.setItem(STORAGE_KEYS.FAILED_ATTEMPTS, attempts);
      return attempts;
    }

    function resetFailedAttempts() {
      localStorage.removeItem(STORAGE_KEYS.FAILED_ATTEMPTS);
      localStorage.removeItem(STORAGE_KEYS.LOCKED_UNTIL);
    }

    function setLockout(duration) {
      const lockedUntil = Date.now() + duration;
      localStorage.setItem(STORAGE_KEYS.LOCKED_UNTIL, lockedUntil);
    }

    function isLockedOut() {
      const lockedUntil = localStorage.getItem(STORAGE_KEYS.LOCKED_UNTIL);
      if (!lockedUntil) return false;
      
      if (Date.now() > parseInt(lockedUntil)) {
        resetFailedAttempts();
        return false;
      }
      return true;
    }

    function getTimeUntilUnlock() {
      const lockedUntil = parseInt(localStorage.getItem(STORAGE_KEYS.LOCKED_UNTIL));
      const now = Date.now();
      return Math.max(0, Math.ceil((lockedUntil - now) / 1000));
    }

    function checkAndHandleLockout(step) {
      if (!isLockedOut()) return false;
      
      const secondsLeft = getTimeUntilUnlock();
      const minutes = Math.floor(secondsLeft / 60);
      const seconds = secondsLeft % 60;
      
      document.getElementById(`msg${step}`).textContent = 
        `Слишком много неудачных попыток. Попробуйте снова через ${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Блокируем все кнопки отправки
      ['btn1', 'btn2', 'btn3'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.disabled = true;
      });
      
      return true;
    }

    (async()=>{
      const key = await importKeyRaw(MASTER_KEY);

      async function verifyStep(login, pass, expected){
        const data = login + ':' + pass;
        const sig = await hmacBase64(key, data);
        if(sig.length !== expected.length) return false;
        let res = 0;
        for(let i=0;i<sig.length;i++) res |= sig.charCodeAt(i) ^ expected.charCodeAt(i);
        return res === 0;
      }

      // Общая функция для обработки попыток
      function handleAuthAttempt(step, loginId, passId, expectedSig, nextFormId) {
        const button = document.getElementById(`btn${step}`);
        const loginField = document.getElementById(loginId);
        const passField = document.getElementById(passId);
        const messageEl = document.getElementById(`msg${step}`);
        
        button.addEventListener('click', async function() {
          // Проверяем блокировку при каждом клике
          if (checkAndHandleLockout(step)) {
            return;
          }
          
          const l = loginField.value.trim();
          const p = passField.value;
          
          const ok = await verifyStep(l, p, expectedSig);
          
          if(ok){
            resetFailedAttempts(); // Сбрасываем при успешном входе
            setBackgroundColor('#0b612a');
            if (nextFormId) {
              document.getElementById(`form${step}`).classList.add('hidden');
              document.getElementById(nextFormId).classList.remove('hidden');
            } else {
              // Финальный успешный вход
              document.getElementById('stage').innerHTML = `
                <div class="final-page">
                  <div class="welcome-text">Welcome!</div>
                  <div class="subtitle">Добро пожаловать — доступ разрешён.</div>
                </div>`;
              setBackgroundColor('#000');
            }
            messageEl.textContent = `Step ${step}: успешно.`;
          } else {
            const attempts = incrementFailedAttempts();
            let lockoutTime = null;
            
            // Определяем продолжительность блокировки
            if (attempts >= LOCKOUT_CONFIG.extended.attempts) {
              lockoutTime = LOCKOUT_CONFIG.extended.duration;
            } else if (attempts >= LOCKOUT_CONFIG.initial.attempts) {
              lockoutTime = LOCKOUT_CONFIG.initial.duration;
            }
            
            if (lockoutTime) {
              setLockout(lockoutTime);
              checkAndHandleLockout(step); // Активируем блокировку
            } else {
              const remaining = LOCKOUT_CONFIG.initial.attempts - attempts;
              setBackgroundColor('#6b0b0b');
              messageEl.textContent = `Step ${step}: неверный логин или пароль. Осталось попыток: ${remaining}`;
            }
          }
        });
      }

      // Инициализация обработчиков для каждой ступени
      handleAuthAttempt('1', 'login1', 'pass1', EXPECTED.step1, 'form2');
      handleAuthAttempt('2', 'login2', 'pass2', EXPECTED.step2, 'form3');
      handleAuthAttempt('3', 'login3', 'pass3', EXPECTED.step3, null);
      
      // Проверяем блокировку при загрузке страницы
      window.addEventListener('load', function() {
        checkAndHandleLockout('1');
      });

    })();
  </script>
</body>
</html>
